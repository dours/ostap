%% (C) Dmitri Boulytchev, St.Petersburg State University, 2008.
%% Support macros for LaTeX documentation generated by Ostap.
%% This file is in the public domain; do what you want with it.

\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{ostap}
              [2008/28/01 v2.0 OSTAP grammar printing support]

\usepackage{ifthen}
\usepackage{calc}

\makeatletter
\newlength{\@oslength}
\newlength{\@oscodeindent}
\newlength{\@oscodepos}
\newlength{\osindent}
\newlength{\osvskip}
\setlength{\osindent}{5mm}
\setlength{\osvskip}{5mm}
\setlength{\@oscodeindent}{0mm}
\setlength{\@oscodepos}{0mm}

\newcommand{\oscodeindent}{\hspace*{\@oscodeindent}\setlength{\@oscodepos}{\@oscodeindent}}
\newcommand{\osnextlevel}{\addtolength{\@oscodeindent}{\osindent}}

\def\ossoftskip{}
\def\osbr{}

\newcommand{\oswithpos}[1]{%
   \settowidth{\@oslength}{#1}{#1}\addtolength{\@oscodepos}{\@oslength}%
}

\newcommand{\osdroppos}{\setlength{\@oscodepos}{0mm}}

\newcommand{\osbrblock}[3]{%  
 \settowidth{\@oslength}{%
    {%
     \def\osfralt{}%
     \def\osralt{\enskip$|$\enskip}%
     \def\ossoftskip{\enskip}%
     \def\osbr{ }%
     \oswithpos{#1}\oswithpos{#3}\oswithpos{#2}}%
    }% 
 \addtolength{\@oslength}{\@oscodepos}%
 \addtolength{\@oslength}{5mm}%
 \ifthenelse{\@oslength > \linewidth}%
 {%
   \oswithpos{#1}%
   {%
    \osnextlevel%
    \def\ossoftskip{}%
    \def\osbr{\\ \osdroppos\oswithpos{\oscodeindent}}%
    \def\osfralt{\phantom{$|$\enskip}}%
    \def\osralt{\osbr$|$\enskip}\osbr%
    \oswithpos{#3}%
   }%
   \osbr\oswithpos{#2}%   
 }%
 {%
  {%
   \def\osfralt{}%
   \def\osralt{\enskip$|$\enskip}%
   \def\ossoftskip{\enskip}%
   \def\osbr{ }%
   \oswithpos{{#1}{#3}{#2}}%
  }%
 }%
}

\newcommand{\osrblock}[1]{%
 \settowidth{\@oslength}{%
    {%
     \def\osfralt{}%
     \def\osralt{\enskip$|$\enskip}%
     \def\ossoftskip{\enskip}%
     \def\osbr{ }%
     \oswithpos{#1}}%
    }% 
 \addtolength{\@oslength}{\@oscodepos}%
 \addtolength{\@oslength}{5mm}%
 \ifthenelse{\@oslength > \linewidth}%
 {%
   {%
    \osnextlevel%
    \def\ossoftskip{}%
    \def\osbr{\\ \osdroppos\oswithpos{\oscodeindent}}%
    \def\osfralt{\phantom{$|$\enskip}}%
    \def\osralt{\osbr$|$\enskip}% %%\osbr
    \oswithpos{#1}%
   }% %%\osbr
 }%
 {%
  {%
   \def\osfralt{}%
   \def\osralt{\enskip$|$\enskip}%
   \def\ossoftskip{\enskip}%
   \def\osbr{ }%
   \oswithpos{#1}%
  }%
 }%
}

\newcounter{osrnumber}
\newcommand{\osrref}[1]{\textup{\texttt{\tiny(\ref{#1}:\pageref{#1})}}}

\newcommand{\osrsymbol}[1]{\textbf{#1}}

\newcommand{\osrdef}{\mbox{\enskip\osrsymbol{:}\enskip}}
\newcommand{\osrend}{\mbox{\osrsymbol{;}}}

\newcommand{\osropt}[1]{%
  \osbrblock{\osrsymbol{[}}{\osrsymbol{]}}{\ossoftskip#1\ossoftskip}%
}

\newcommand{\osrgroup}[1]{%
  \osbrblock{\osrsymbol{(}}{\osrsymbol{)}}{\ossoftskip#1\ossoftskip}%
}

\newcommand{\osraster}[1]{{#1}\osrsymbol{*}}
\newcommand{\osrplus}[1]{{#1}\osrsymbol{+}}
\newcommand{\osrterm}[1]{\osrsymbol{#1}}
\newcommand{\osrnonterm}[1]{\textit{#1}\osrref{#1}}
\newcommand{\osrargs}[1]{\osbrblock{\textup{[}}{\textup{]}}{#1}}
\newcommand{\osrcustom}[1]{\textit{#1}}

\newcommand{\osrule}[2]{%
  \refstepcounter{osrnumber}%
  \noindent%
  \texttt{\small(\arabic{osrnumber})}\enskip%
  {%
  \settowidth{\@oscodeindent}{0mm}% 
  \osbrblock%
     {%
       \textit{#1}\label{#1}\index{#1}%
       \osrdef%
     }%
     {\osrend}%
     {#2\osbr}\osdroppos\\\par%
  }%
}

\newcommand{\osprule}[3]{%
  \refstepcounter{osrnumber}%
  \noindent%
  \texttt{\small(\arabic{osrnumber})}\enskip%
  {%
  \settowidth{\@oscodeindent}{0mm}% 
  \osbrblock%
     {%
       \textit{#1}\label{#1}\index{#1}\textup{#2}%
       \osrdef%
     }%
     {\osrend}%
     {#3\osbr}\osdroppos\\\par%  
  }%
}

\def\makehypletter{\catcode`\-=11\relax}
\def\makehypother{\catcode`\-=12\relax}

\renewcommand{\makehypletter}{\chardef\hypcode\the\catcode`\-\catcode`\-11\relax}
\renewcommand{\makehypother}{\catcode`\-=\hypcode\relax}

\endinput
